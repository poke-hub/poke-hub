{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>

    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>

                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                        <a href="#" data-bs-toggle="modal" data-bs-target="#infoModal">
                            <i data-feather="info"></i>
                          </a>
                        </h1>

                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a UVLHub. Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">UVL models</h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">

                <ul class="nav nav-tabs" id="sourceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="tab-file" data-bs-toggle="tab" href="#pane-file" role="tab" aria-controls="pane-file" aria-selected="true">Single .uvl</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="tab-zip" data-bs-toggle="tab" href="#pane-zip" role="tab" aria-controls="pane-zip" aria-selected="false">ZIP</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="tab-github" data-bs-toggle="tab" href="#pane-github" role="tab" aria-controls="pane-github" aria-selected="false">GitHub</a>
                    </li>
                </ul>

                <div class="tab-content pt-3" id="sourceTabsContent">

                    <div class="tab-pane fade show active" id="pane-file" role="tabpanel" aria-labelledby="tab-file">
                        <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                            <div id="dropzone-text"></div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="pane-zip" role="tabpanel" aria-labelledby="tab-zip">
                        <div class="form-inline">
                            <input type="file" id="zipFile" class="form-control mr-2" accept=".zip">
                            <button id="processZipBtn" class="btn btn-outline-primary">Procesar ZIP</button>
                        </div>
                        <div class="mt-2">
                            <div class="alert alert-success py-2 px-3" id="zipSavedBox" style="display:none;">
                                <b>Guardados:</b>
                                <ul id="zipSavedList" class="mb-0"></ul>
                            </div>
                            <div class="alert alert-secondary py-2 px-3" id="zipIgnoredBox" style="display:none;">
                                <b>Ignorados:</b>
                                <ul id="zipIgnoredList" class="mb-0"></ul>
                            </div>
                            <div class="alert alert-danger py-2 px-3" id="zipErrorBox" style="display:none;"></div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pane-github" role="tabpanel" aria-labelledby="tab-github">
                        <div class="row">
                            <div class="col-lg-7 mb-2">
                                <label class="form-label">Repo URL</label>
                                <input type="text" id="ghUrl" class="form-control" placeholder="https://github.com/owner/repo">
                            </div>
                            <div class="col-lg-3 mb-2">
                                <label class="form-label">Branch (opcional)</label>
                                <input type="text" id="ghBranch" class="form-control" placeholder="main">
                            </div>
                            <div class="col-lg-2 mb-2">
                                <label class="form-label">Subdir (opt.)</label>
                                <input type="text" id="ghSubdir" class="form-control" placeholder="path/in/repo">
                            </div>
                        </div>
                        <button id="importGithubBtn" class="btn btn-outline-primary">Importar desde GitHub</button>
                        <div class="mt-2">
                            <div class="alert alert-success py-2 px-3" id="ghSavedBox" style="display:none;">
                                <b>Guardados:</b>
                                <ul id="ghSavedList" class="mb-0"></ul>
                            </div>
                            <div class="alert alert-secondary py-2 px-3" id="ghIgnoredBox" style="display:none;">
                                <b>Ignorados:</b>
                                <ul id="ghIgnoredList" class="mb-0"></ul>
                            </div>
                            <div class="alert alert-danger py-2 px-3" id="ghErrorBox" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <span class="text-danger" id="alerts" style="display: none"></span>

                <ul class="mt-2" id="file-list"></ul>

                <script>
                    // Función reutilizable para añadir un modelo a la lista
                    function appendUploadedModel(filename) {
                        show_upload_dataset();

                        const fileList = document.getElementById('file-list');

                        const listItem = document.createElement('li');
                        const h4Element = document.createElement('h4');
                        h4Element.textContent = filename;
                        listItem.appendChild(h4Element);

                        const formUniqueId = generateIncrementalId();

                        const formButton = document.createElement('button');
                        formButton.innerHTML = 'Show info';
                        formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', 'btn-sm');
                        formButton.style.borderRadius = '5px';
                        formButton.id = formUniqueId + "_button";

                        let space = document.createTextNode(" ");
                        listItem.appendChild(space);

                        const removeButton = document.createElement('button');
                        removeButton.innerHTML = 'Delete model';
                        removeButton.classList.add('remove-button', 'btn', 'btn-outline-danger', 'btn-sm', 'remove-button');
                        removeButton.style.borderRadius = '5px';

                        removeButton.addEventListener('click', function () {
                            const xhr = new XMLHttpRequest();
                            xhr.open('POST', '/dataset/file/delete', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            xhr.onload = function () {
                                if (xhr.status === 200) {
                                    fileList.removeChild(listItem);
                                    if (!fileList.children.length) {
                                        document.getElementById("upload_dataset").style.display = "none";
                                        clean_upload_errors();
                                    }
                                }
                            };
                            xhr.send(JSON.stringify({file: filename}));
                        });

                        listItem.appendChild(formButton);
                        listItem.appendChild(removeButton);

                        const formContainer = document.createElement('div');
                        formContainer.id = formUniqueId + "_form";
                        formContainer.classList.add('uvl_form', "mt-3");
                        formContainer.style.display = "none";

                        formContainer.innerHTML = `
                            <div class="row">
                                <input type="hidden" value="${filename}" name="feature_models-${formUniqueId}-uvl_filename">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Title</label>
                                                <input type="text" class="form-control" name="feature_models-${formUniqueId}-title">
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Description</label>
                                                <textarea rows="4" class="form-control" name="feature_models-${formUniqueId}-desc"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-12">
                                            <div class="mb-3">
                                                <label class="form-label" for="publication_type">Publication type</label>
                                                <select class="form-control" name="feature_models-${formUniqueId}-publication_type">
                                                    <option value="none">None</option>
                                                    <option value="annotationcollection">Annotation Collection</option>
                                                    <option value="book">Book</option>
                                                    <option value="section">Book Section</option>
                                                    <option value="conferencepaper">Conference Paper</option>
                                                    <option value="datamanagementplan">Data Management Plan</option>
                                                    <option value="article">Journal Article</option>
                                                    <option value="patent">Patent</option>
                                                    <option value="preprint">Preprint</option>
                                                    <option value="deliverable">Project Deliverable</option>
                                                    <option value="milestone">Project Milestone</option>
                                                    <option value="proposal">Proposal</option>
                                                    <option value="report">Report</option>
                                                    <option value="softwaredocumentation">Software Documentation</option>
                                                    <option value="taxonomictreatment">Taxonomic Treatment</option>
                                                    <option value="technicalnote">Technical Note</option>
                                                    <option value="thesis">Thesis</option>
                                                    <option value="workingpaper">Working Paper</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-6">
                                            <div class="mb-3">
                                                <label class="form-label" for="publication_doi">Publication DOI</label>
                                                <input class="form-control" name="feature_models-${formUniqueId}-publication_doi" type="text" value="">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">Tags (separated by commas)</label>
                                                <input type="text" class="form-control" name="feature_models-${formUniqueId}-tags">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">UVL version</label>
                                                <input type="text" class="form-control" name="feature_models-${formUniqueId}-uvl_version">
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Authors</label>
                                                <div id="${formContainer.id}_authors"></div>
                                                <button type="button" class="add_author_to_uvl btn btn-secondary" id="${formContainer.id}_authors_button">Add author</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;

                        formButton.addEventListener('click', function () {
                            if (formContainer.style.display === "none") {
                                formContainer.style.display = "block";
                                formButton.innerHTML = 'Hide info';
                            } else {
                                formContainer.style.display = "none";
                                formButton.innerHTML = 'Show info';
                            }
                        });

                        listItem.appendChild(formContainer);
                        fileList.appendChild(listItem);
                    }

                    // Dropzone (individual .uvl) -> /dataset/file/upload
                    let dropzone = Dropzone.options.myDropzone = {
                        url: "/dataset/file/upload",
                        paramName: 'file',
                        maxFilesize: 10,
                        acceptedFiles: '.uvl',
                        init: function () {
                            const alerts = document.getElementById('alerts');

                            this.on('addedfile', function (file) {
                                let ext = file.name.split('.').pop();
                                if (ext !== 'uvl') {
                                    this.removeFile(file);
                                    const p = document.createElement('p');
                                    p.textContent = 'Invalid file extension: ' + file.name;
                                    alerts.appendChild(p);
                                    alerts.style.display = 'block';
                                }
                            });

                            this.on('success', function (file, response) {
                                appendUploadedModel(response.filename);
                            });

                            this.on('error', function (file, response) {
                                console.error("Error uploading file: ", response);
                                const p = document.createElement('p');
                                p.textContent = 'UVL not valid: ' + file.name;
                                alerts.appendChild(p);
                                alerts.style.display = 'block';
                            });
                        }
                    };

                    // ZIP -> /dataset/zip/upload
                    document.getElementById('processZipBtn').addEventListener('click', function (e) {
                        e.preventDefault();

                        const zipInput = document.getElementById('zipFile');
                        const savedBox = document.getElementById('zipSavedBox');
                        const ignoredBox = document.getElementById('zipIgnoredBox');
                        const savedList = document.getElementById('zipSavedList');
                        const ignoredList = document.getElementById('zipIgnoredList');
                        const errorBox = document.getElementById('zipErrorBox');

                        savedBox.style.display = 'none';
                        ignoredBox.style.display = 'none';
                        errorBox.style.display = 'none';
                        savedList.innerHTML = '';
                        ignoredList.innerHTML = '';

                        if (!zipInput.files.length) {
                            errorBox.textContent = 'Selecciona un archivo ZIP.';
                            errorBox.style.display = 'block';
                            return;
                        }

                        const fd = new FormData();
                        fd.append('file', zipInput.files[0]);

                        fetch('/dataset/zip/upload', { method: 'POST', body: fd })
                            .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
                            .then(({ ok, status, body }) => {
                                if (!ok) throw new Error(body.message || ('ZIP error (' + status + ')'));

                                (body.saved || []).forEach(fn => {
                                    const li = document.createElement('li'); li.textContent = fn; savedList.appendChild(li);
                                    appendUploadedModel(fn); // Llama a la función reutilizable
                                });
                                (body.ignored || []).forEach(fn => {
                                    const li = document.createElement('li'); li.textContent = fn; ignoredList.appendChild(li);
                                });

                                if ((body.saved || []).length) savedBox.style.display = 'block';
                                if ((body.ignored || []).length) ignoredBox.style.display = 'block';
                            })
                            .catch(err => {
                                errorBox.textContent = err.message;
                                errorBox.style.display = 'block';
                            });
                    });

                    // GitHub -> /dataset/github/import
                    document.getElementById('importGithubBtn').addEventListener('click', function (e) {
                        e.preventDefault();

                        const url = (document.getElementById('ghUrl').value || '').trim();
                        const branch = (document.getElementById('ghBranch').value || '').trim();
                        const subdir = (document.getElementById('ghSubdir').value || '').trim();

                        const savedBox = document.getElementById('ghSavedBox');
                        const ignoredBox = document.getElementById('ghIgnoredBox');
                        const savedList = document.getElementById('ghSavedList');
                        const ignoredList = document.getElementById('ghIgnoredList');
                        const errorBox = document.getElementById('ghErrorBox');

                        savedBox.style.display = 'none';
                        ignoredBox.style.display = 'none';
                        errorBox.style.display = 'none';
                        savedList.innerHTML = '';
                        ignoredList.innerHTML = '';

                        if (!url) {
                            errorBox.textContent = 'Introduce una URL de GitHub válida.';
                            errorBox.style.display = 'block';
                            return;
                        }

                        fetch('/dataset/github/import', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ repo_url: url, branch: branch || 'main', subdir: subdir || null })
                        })
                        .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
                        .then(({ ok, status, body }) => {
                            if (!ok) throw new Error(body.message || ('GitHub import error (' + status + ')'));

                            (body.saved || []).forEach(fn => {
                                const li = document.createElement('li'); li.textContent = fn; savedList.appendChild(li);
                                appendUploadedModel(fn); // Llama a la función reutilizable
                            });
                            (body.ignored || []).forEach(fn => {
                                const li = document.createElement('li'); li.textContent = fn; ignoredList.appendChild(li);
                            });

                            if ((body.saved || []).length) savedBox.style.display = 'block';
                            if ((body.ignored || []).length) ignoredBox.style.display = 'block';
                        })
                        .catch(err => {
                            errorBox.textContent = err.message;
                            errorBox.style.display = 'block';
                        });
                    });
                </script>

            </div>
        </div> 
        
    </div> <div class="row" id="upload_dataset" style="display: none">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Upload dataset</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my feature models automatically uploaded to Zenodo and made available to the public according to the <a
                            href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                </label>

                <button id="upload_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Upload dataset</button>

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    Uploading dataset, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                            connection to the Zenodo API</h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Zenodo API and synchronization of your
                            dataset
                            files may not be possible. We will save your files locally to eventually synchronize
                            them with
                            Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                            anything about it.
                        </p>
                    </div>
                </div>


                <span class="text-danger mt-2" id="upload_error" style="display: none">

                    </span>

                <script>
                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>

            </div>




        </div>

    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>
{% endblock %}