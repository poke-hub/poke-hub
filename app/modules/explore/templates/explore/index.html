{% extends "base_template.html" %}

{% block title %}Explore - PokeHub{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="h2 mb-3"><b>Explore Datasets</b></h1>

    <!-- Filtros y Búsqueda -->
    <div class="row g-3 mb-4">
        <div class="col-md-12">
            <input type="text" id="query" class="form-control" placeholder="Search by title, description, pokemon..." value="{{ query }}">
        </div>
        <div class="col-md-2">
            <select id="sorting" class="form-select">
                <option value="created_at" selected>Sort by Date</option>
                <option value="max_ev_count">Sort by EV count</option>
                <option value="max_iv_count">Sort by IV count</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="desc" class="form-select">
                <option value="false" selected>Ascending</option>
                <option value="true">Descending</option>
            </select>
        </div>
        <div class="col-md-2">
            <button id="clear-filters-btn" class="btn btn-secondary w-100">Clear Filters</button>
        </div>
    </div>

    <!-- Contenedor de Resultados -->
    <div class="row">
        <div id="results-container" class="row col-12">
            
        </div>
        <div id="results-not-found" class="col-12 text-center" style="display: none;">
            <img src="{{ url_for('static', filename='img/items/not_found.svg') }}"
                 style="width: 50%; max-width: 100px; height: auto; margin-top: 30px"/>
            <p style="margin-top: 20px">
                We have not found any datasets that meet your search criteria. <br>How about trying some others?
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Referencias a los elementos del DOM
    const queryInput = document.getElementById('query');
    const sortingSelect = document.getElementById('sorting');
    const descSelect = document.getElementById('desc');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const resultsContainer = document.getElementById('results-container');
    const notFoundMessage = document.getElementById('results-not-found');

    // Función para renderizar los resultados
    function renderResults(datasets) {
        resultsContainer.innerHTML = ''; // Limpiar resultados anteriores

        if (datasets.length === 0) {
            notFoundMessage.style.display = 'block';
            return;
        }
        
        notFoundMessage.style.display = 'none';
        datasets.forEach(dataset => {
            const authorsHtml = Array.isArray(dataset.authors) ? dataset.authors.join(', ') : (dataset.authors || 'Unknown');
            console.log(dataset);
            const card = `
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><a href="/doi/${dataset.doi}">${dataset.title}</a></h5>
                            <h6 class="card-subtitle mb-2 text-muted">by ${authorsHtml}</h6>
                            <p class="card-text">${(dataset.description || '').substring(0, 100)}...</p>
                        </div>
                        <div class="card-footer text-muted">
                            <small>Type: ${dataset.publication_type || 'N/A'}</small>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.insertAdjacentHTML('beforeend', card);
        });
    }

    // Función para realizar la búsqueda
    async function fetchResults() {
        const criteria = {
            query: queryInput.value,
            sorting: sortingSelect.value,
            desc: descSelect.value
        };

        try {
            const response = await fetch('/explore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(criteria)
            });

            // Handle Elasticsearch service unavailable (HTTP 503) with a friendly UI
            if (response.status === 503) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning text-center w-100" role="alert">
                        <strong>ElasticSearch temporarily unavailable.</strong>
                        <div class="mt-2">The ElasticSearch service is down. Please contact your project manager if you need the service.</div>
                        <button id="retry-btn" class="btn btn-sm btn-primary mt-3">Retry</button>
                    </div>
                `;
                const retryBtn = document.getElementById('retry-btn');
                if (retryBtn) retryBtn.addEventListener('click', fetchResults);
                return;
            }

            if (!response.ok) throw new Error('Network response was not ok');

            const datasets = await response.json();
            renderResults(datasets);
        } catch (error) {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = '<p class="text-center text-danger">Error loading results.</p>';
        }
    }

    // Función para limpiar los filtros a su estado inicial
    function clearFilters() {
        queryInput.value = '';
        sortingSelect.value = 'created_at';
        descSelect.value = 'false';

        // Después de limpiar, volvemos a buscar
        fetchResults();
    }

    // --- Event Listeners ---
    let searchTimeout;
    queryInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(fetchResults, 300); // Pequeño retraso para no saturar
    });

    sortingSelect.addEventListener('change', fetchResults);
    descSelect.addEventListener('change', fetchResults);
    clearFiltersBtn.addEventListener('click', clearFilters);

    // Carga inicial de resultados al entrar en la página
    fetchResults();
});
</script>
{% endblock %}